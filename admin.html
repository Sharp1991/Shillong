<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FixMyCity - Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; }
    #dashboard { display: none; }
    .container { max-width: 1200px; margin: auto; }
    .action-btn { margin-right: 5px; }
  </style>
</head>
<body>

<div id="login">
  <div class="container text-center">
    <h1 class="mb-4">Admin Login</h1>
    <input type="password" id="adminPassword" class="form-control mb-3" placeholder="Enter admin password">
    <button id="loginBtn" class="btn btn-primary">Login</button>
    <p id="errorMsg" class="text-danger mt-2"></p>
  </div>
</div>

<div id="dashboard">
  <div class="container">
    <h1 class="mb-4">Admin Dashboard</h1>
    <table class="table table-bordered table-striped" id="reportTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>User Email</th>
          <th>Title</th>
          <th>Description</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Status</th>
          <th>Photo</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
  const ADMIN_PASSWORD = 'FixMyCity123';

  const loginDiv = document.getElementById('login');
  const dashboardDiv = document.getElementById('dashboard');
  const loginBtn = document.getElementById('loginBtn');
  const errorMsg = document.getElementById('errorMsg');

  loginBtn.addEventListener('click', () => {
    const input = document.getElementById('adminPassword').value;
    if(input === ADMIN_PASSWORD) {
      loginDiv.style.display = 'none';
      dashboardDiv.style.display = 'block';
      loadReports();
    } else {
      errorMsg.textContent = 'Incorrect password!';
    }
  });

  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabaseUrl = 'https://kdjwrgcyhtrxfjvhonfh.supabase.co';
  const supabaseKey = 'sb_publishable_SqTmlMsLjOXafXiv1vwxcg_--j67cTK';
  const supabase = createClient(supabaseUrl, supabaseKey);

  async function loadReports() {
    const { data, error } = await supabase.from('report').select('*').order('id', { ascending: false });
    if(error) {
      alert('Error fetching reports: ' + error.message);
      return;
    }

    const tbody = document.querySelector('#reportTable tbody');
    tbody.innerHTML = '';
    data.forEach(report => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${report.id}</td>
        <td>${report.user_email || ''}</td>
        <td>${report.title}</td>
        <td>${report.description}</td>
        <td>${report.latitude}</td>
        <td>${report.longitude}</td>
        <td>
          <select class="form-select form-select-sm status-select" data-id="${report.id}">
            <option value="Reported" ${report.status==='Reported'?'selected':''}>Reported</option>
            <option value="In Progress" ${report.status==='In Progress'?'selected':''}>In Progress</option>
            <option value="Fixed" ${report.status==='Fixed'?'selected':''}>Fixed</option>
          </select>
        </td>
        <td>${report.photo_url ? `<a href="${report.photo_url}" target="_blank">View Photo</a>` : ''}</td>
        <td>
          <button class="btn btn-danger btn-sm delete-btn" data-id="${report.id}">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    attachEventListeners();
  }

  function attachEventListeners() {
    // Update Status
    document.querySelectorAll('.status-select').forEach(select => {
      select.addEventListener('change', async (e) => {
        const id = e.target.dataset.id;
        const newStatus = e.target.value;
        const { error } = await supabase.from('report').update({ status: newStatus }).eq('id', id);
        if(error) alert('Error updating status: ' + error.message);
      });
    });

    // Delete Report
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        if(confirm('Are you sure you want to delete this report?')) {
          const { error } = await supabase.from('report').delete().eq('id', id);
          if(error) alert('Error deleting report: ' + error.message);
          else loadReports();
        }
      });
    });
  }
</script>

</body>
</html>
