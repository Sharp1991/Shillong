<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FixMyCity - Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; }
    table { font-size: 0.9rem; }
    .status-select { width: 120px; }
  </style>
</head>
<body>

  <h1 class="mb-4">Admin Dashboard - FixMyCity</h1>
  <table class="table table-striped" id="reportTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Description</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Photo</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Reports will appear here -->
    </tbody>
  </table>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabaseUrl = 'https://kdjwrgcyhtrxfjvhonfh.supabase.co';
    const supabaseKey = 'sb_publishable_SqTmlMsLjOXafXiv1vwxcg_--j67cTK';
    const supabase = createClient(supabaseUrl, supabaseKey);

    const tbody = document.querySelector('#reportTable tbody');

    async function loadReports() {
      const { data: reports, error } = await supabase.from('report').select('*').order('created_at', { ascending: false });
      if(error) return console.error(error);

      tbody.innerHTML = '';
      reports.forEach(report => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${report.id}</td>
          <td>${report.title}</td>
          <td>${report.description}</td>
          <td>${report.latitude}</td>
          <td>${report.longitude}</td>
          <td>${report.photo_url ? `<a href="${report.photo_url}" target="_blank">View</a>` : ''}</td>
          <td>
            <select class="form-select status-select" data-id="${report.id}">
              <option value="Reported" ${report.status === 'Reported' ? 'selected' : ''}>Reported</option>
              <option value="In Progress" ${report.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
              <option value="Fixed" ${report.status === 'Fixed' ? 'selected' : ''}>Fixed</option>
            </select>
          </td>
          <td>
            <button class="btn btn-danger btn-sm delete-btn" data-id="${report.id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Add event listeners for status change
      document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', async (e) => {
          const id = e.target.dataset.id;
          const status = e.target.value;
          const { error } = await supabase.from('report').update({ status }).eq('id', id);
          if(error) alert('Error updating status: ' + error.message);
        });
      });

      // Add event listeners for delete
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.dataset.id;
          if(confirm('Are you sure you want to delete this report?')) {
            const { error } = await supabase.from('report').delete().eq('id', id);
            if(error) return alert('Error deleting report: ' + error.message);
            loadReports(); // Refresh table
          }
        });
      });
    }

    loadReports();
  </script>

</body>
</html>
