<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road Conditions Heatmap</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a; 
            color: white;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        .header p { opacity: 0.9; font-size: 1.1rem; }
        
        .nav { text-align: center; margin: 15px 0; }
        .nav a { 
            color: white; 
            margin: 0 15px; 
            text-decoration: none; 
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        .nav a:hover { background: rgba(255,255,255,0.2); }
        .nav a.active { 
            background: rgba(255,255,255,0.3); 
            font-weight: bold;
        }
        
        #map { height: calc(100vh - 180px); width: 100%; }
        
        .debug-panel {
            position: absolute;
            top: 180px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
            font-size: 12px;
            border-left: 4px solid #dc3545;
        }
        
        .debug-info {
            margin: 5px 0;
            font-family: monospace;
        }
        
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        
        .controls {
            position: absolute; top: 180px; right: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 15px;
            border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            color: #333; min-width: 250px;
        }
        
        .loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95); padding: 20px 30px;
            border-radius: 10px; text-align: center; z-index: 1000; color: #333;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõ£Ô∏è Road Conditions Heatmap</h1>
        <p>Visualizing pothole reports and road issues</p>
        <div class="nav">
            <a href="index.html">üì± Report Potholes</a>
            <a href="heatmap.html" class="active">üó∫Ô∏è View Heatmap</a>
        </div>
    </div>

    <div id="map"></div>

    <!-- Debug Panel - Shows what's happening -->
    <div class="debug-panel" id="debugPanel">
        <strong>üîß Debug Info:</strong>
        <div class="debug-info" id="debugStatus">Initializing...</div>
        <div class="debug-info" id="debugData">No data loaded</div>
        <div class="debug-info" id="debugError">No errors</div>
    </div>

    <div class="controls">
        <button id="refreshBtn" style="width: 100%; padding: 10px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
            üîÑ Refresh Data
        </button>
        <div style="margin-top: 10px; font-size: 12px; color: #666;">
            <div>Total Points: <span id="pointCount">0</span></div>
            <div>Last Update: <span id="lastUpdate">Never</span></div>
        </div>
    </div>

    <div class="loading" id="loadingIndicator">
        <div>üîÑ Loading road data...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Use the same Supabase import as your working app -->
    <script type="module">
        // Import Supabase the same way your working app does
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        // Your Supabase credentials - same as working app
        const SUPABASE_URL = 'https://kdjwrgcyhtrxfjvhonfh.supabase.co'
        const SUPABASE_KEY = 'sb_publishable_SqTmlMsLjOXafXiv1vwxcg_--j67cTK'
        
        // Debug elements
        const debugStatus = document.getElementById('debugStatus')
        const debugData = document.getElementById('debugData')
        const debugError = document.getElementById('debugError')
        const pointCount = document.getElementById('pointCount')
        const lastUpdate = document.getElementById('lastUpdate')
        const loadingIndicator = document.getElementById('loadingIndicator')

        let map
        let supabase
        let markers = []

        // Update debug info
        function updateDebug(status, data, error = '') {
            debugStatus.textContent = status
            debugData.textContent = data
            debugError.textContent = error
            
            if (error) {
                debugError.className = 'debug-info error'
            } else {
                debugError.className = 'debug-info success'
            }
        }

        // Initialize everything
        async function initializeApp() {
            updateDebug('Initializing Supabase...', 'Connecting to database')
            
            try {
                // Initialize Supabase same as your working app
                supabase = createClient(SUPABASE_URL, SUPABASE_KEY)
                updateDebug('Supabase initialized', 'Testing connection...')
                
                // Test connection
                const { data, error } = await supabase
                    .from('road_clicks')
                    .select('count')
                    .limit(1)
                
                if (error) {
                    throw new Error(`Connection failed: ${error.message}`)
                }
                
                updateDebug('‚úÖ Connected to Supabase', 'Loading map...')
                
                // Initialize map
                initMap()
                
                // Load data
                await loadData()
                
            } catch (error) {
                updateDebug('‚ùå Initialization failed', '', error.message)
                loadingIndicator.style.display = 'none'
            }
        }

        function initMap() {
            map = L.map('map').setView([25.5788, 91.8933], 13)
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map)
            
            updateDebug('Map initialized', 'Ready to load data')
        }

        async function loadData() {
            loadingIndicator.style.display = 'block'
            updateDebug('Loading data...', 'Fetching from road_clicks table')
            
            try {
                // Clear existing markers
                markers.forEach(marker => map.removeLayer(marker))
                markers = []
                
                // Fetch data from your working table
                const { data, error } = await supabase
                    .from('road_clicks')
                    .select('lat, lon, intensity, intensity_label, created_at')
                    .order('created_at', { ascending: false })
                
                if (error) {
                    throw new Error(`Database error: ${error.message}`)
                }
                
                updateDebug(`‚úÖ Data loaded`, `${data.length} records found`)
                
                if (data.length === 0) {
                    updateDebug('‚ö†Ô∏è No data', 'road_clicks table is empty')
                    pointCount.textContent = '0'
                } else {
                    // Add markers to map
                    data.forEach(item => {
                        const color = getColorForIntensity(item.intensity)
                        const marker = L.circleMarker([item.lat, item.lon], {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.7,
                            radius: 8
                        }).addTo(map)
                        
                        marker.bindPopup(`
                            <strong>${item.intensity_label}</strong><br>
                            Intensity: ${item.intensity}/4<br>
                            Date: ${new Date(item.created_at).toLocaleDateString()}
                        `)
                        
                        markers.push(marker)
                    })
                    
                    pointCount.textContent = data.length
                    updateDebug('‚úÖ Map updated', `Added ${data.length} markers`)
                }
                
                lastUpdate.textContent = new Date().toLocaleTimeString()
                
            } catch (error) {
                updateDebug('‚ùå Load failed', '', error.message)
            } finally {
                loadingIndicator.style.display = 'none'
            }
        }

        function getColorForIntensity(intensity) {
            switch(intensity) {
                case 1: return '#28a745' // Green
                case 2: return '#ffc107' // Yellow
                case 3: return '#fd7e14' // Orange
                case 4: return '#dc3545' // Red
                default: return '#666'
            }
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', loadData)

        // Start the app
        initializeApp()
    </script>
</body>
</html>
