<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  // Supabase credentials
  const supabaseUrl = 'https://kdjwrgcyhtrxfjvhonfh.supabase.co';
  const supabaseKey = 'PASTE_YOUR_ANON_KEY_HERE';
  const supabase = createClient(supabaseUrl, supabaseKey);

  // Initialize Map
  const locationMap = L.map('locationMap').setView([25.5788, 91.8933], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(locationMap);

  let selectedLocation = null;
  let locationMarker = null;

  locationMap.on('click', (e) => {
    selectedLocation = e.latlng;
    if(locationMarker) locationMap.removeLayer(locationMarker);
    locationMarker = L.marker(selectedLocation).addTo(locationMap);
    document.getElementById('locationCoords').textContent =
      `Latitude: ${selectedLocation.lat.toFixed(6)}, Longitude: ${selectedLocation.lng.toFixed(6)}`;
  });

  document.getElementById('reportForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    if (!selectedLocation) {
      alert('Please select a location on the map');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Report';
      return;
    }

    const photoFile = document.getElementById('photo').files[0];
    if (!photoFile) {
      alert('Please upload a photo of the issue');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Report';
      return;
    }

    try {
      // Upload photo to Supabase Storage
      const fileExt = photoFile.name.split('.').pop();
      const fileName = `reports/${Date.now()}.${fileExt}`;
      const { data: uploadData, error: uploadError } = await supabase
        .storage
        .from('reports')
        .upload(fileName, photoFile);

      if (uploadError) throw uploadError;

      const { data: urlData } = supabase
        .storage
        .from('reports')
        .getPublicUrl(fileName);

      // Prepare form data for Supabase table
      const formData = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        latitude: selectedLocation.lat,
        longitude: selectedLocation.lng,
        photo_url: urlData.publicUrl,
        status: 'Reported',
        created_at: new Date().toISOString(),
        page_url: window.location.href // optional
      };

      const { data, error } = await supabase.from('report').insert([formData]);
      if (error) throw error;

      alert('Report submitted successfully!');
      e.target.reset();
      if(locationMarker) locationMap.removeLayer(locationMarker);
      locationMarker = null;
      selectedLocation = null;
      document.getElementById('locationCoords').textContent = 'No location selected';

    } catch(err) {
      console.error(err);
      alert('Error submitting report. Check console for details.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Report';
    }
  });
</script>
